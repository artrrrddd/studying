# Чеклист перед деплоем и при ошибках (Vercel + MongoDB Atlas)

Отмечай пункты по мере проверки. Если что-то не так — исправь и задеплой заново.

---

## 1. Сеть и VPN

- [ ] **VPN выключен** при тесте продакшена в браузере (или включи «split tunneling», чтобы трафик на Vercel/Atlas шёл мимо VPN).
- [ ] Локально без VPN всё работает (логин, регистрация, карточки).
- [ ] При ошибках «timeout» / «connection refused» проверь интернет и файрвол (антивирус, корпоративная сеть).

---

## 2. Переменные окружения на Vercel

**Vercel → проект → Settings → Environment Variables.**

Должны быть заданы для окружений **Production** и **Preview** (если используешь превью):

| Переменная | Обязательно | Пример / примечание |
|------------|-------------|----------------------|
| `DB_URL` | ✅ Да | `mongodb+srv://USER:PASSWORD@cluster0.xxx.mongodb.net/quizlet?retryWrites=true&w=majority` |
| `JWT_ACCESS_SECRET` | ✅ Да | Длинная случайная строка (одинаковая с сервером). |
| `JWT_REFRESH_SECRET` | ✅ Да | Другая длинная строка (одинаковая с сервером). |
| `CLIENT_URL` | ✅ Да | URL фронта: `https://твой-проект.vercel.app` (без слэша в конце). |
| `API_URL` | По желанию | Обычно не нужен на Vercel (API на том же домене). |
| `NODE_ENV` | Нет | Vercel ставит `production` сам. |

- [ ] `DB_URL` **без лишних пробелов** в начале/конце.
- [ ] В пароле из `DB_URL` **спецсимволы закодированы** (`@` → `%40`, `#` → `%23`, `:` → `%3A` и т.д.) или пароль без спецсимволов.
- [ ] После изменения переменных сделан **Redeploy** (Deployments → ⋮ → Redeploy).

---

## 3. MongoDB Atlas

- [ ] **Database Access**: пользователь из `DB_URL` существует, пароль совпадает с тем, что в `DB_URL` (с учётом кодировки).
- [ ] **Network Access**: есть правило, разрешающее доступ (для Vercel обычно «Allow Access from Anywhere» — `0.0.0.0/0`). Без этого запросы с Vercel не дойдут до кластера.
- [ ] Кластер **не приостановлен** (Atlas может «засыпать» бесплатные кластеры при простое).
- [ ] В connection string указано **правильное имя кластера и базы** (например, база `quizlet`).

---

## 4. Клиент (фронт)

Файл `client/.env` или переменные в Vercel для билда клиента:

| Переменная | Где задать | Значение |
|------------|------------|----------|
| `VITE_API_URL` | `client/.env` или Vercel Env (с префиксом для Vite) | Полный URL до API, например `https://твой-проект.vercel.app/api` (в твоём коде при заданной переменной `/api` не дописывается). |

В `client/src/http/index.js` итоговая база:  
`VITE_API_URL + '/api'` или при отсутствии — `'' + '/api'` в проде (то есть запросы на тот же домен).

- [ ] В проде запросы уходят на **тот же домен**, что и фронт (например `https://studying-eta.vercel.app`), и путь к API — `.../api`.
- [ ] В `client/.env` указан **продакшен-URL** (если используешь один проект для прода и превью — один URL; для превью можно отдельный).

---

## 5. CORS и домены

- [ ] В переменной `CLIENT_URL` на Vercel указан **точный URL фронта** (с `https://`, без слэша в конце), например:  
  `https://studying-eta.vercel.app`
- [ ] Если фронт и API на **одном домене** (один проект Vercel, статика + API), то в `server/app.js` для CORS можно оставить `origin: true` в проде или задать тот же домен.

---

## 6. Секреты JWT

- [ ] `JWT_ACCESS_SECRET` и `JWT_REFRESH_SECRET` на Vercel **совпадают** с теми, что в `server/.env` локально (если логинишься и с прода, и с локалки с одними и теми же пользователями).
- [ ] Секреты **не пустые** и достаточно длинные (например 32+ символа).

---

## 7. Деплой и билд

- [ ] В **Vercel** в настройках проекта:
  - **Root Directory**: если проект в подпапке (например `quizlet`), указан корень репо с `api/` и `client/`.
  - **Build Command** / **Output Directory**: соответствуют твоему `vercel.json` (клиент: `client/dist`, билд из `client`).
- [ ] **API** лежит в папке `api/` (у тебя `api/[[...path]].js`) — Vercel автоматически поднимает serverless-функции по путям типа `/api/*`.
- [ ] После правок в коде или в переменных окружения сделан **новый деплой** (git push или Redeploy в Vercel).

---

## 8. Быстрая проверка после деплоя

- [ ] Открываешь `https://твой-проект.vercel.app` — грузится фронт.
- [ ] Страница логина открывается, запрос на `/api/login` или `/api/refresh` не падает с CORS/404.
- [ ] Регистрация и логин проходят без «Непредвиденная ошибка» и без «buffering timed out» / «bad auth».
- [ ] В браузере (F12 → Network) запросы к API возвращают 200 (или ожидаемые 401/400), а не 500 и не таймаут.

---

## Частые ошибки

| Ошибка | Что проверить в первую очередь |
|--------|--------------------------------|
| `buffering timed out` | `DB_URL` на Vercel задан и верный; Atlas Network Access `0.0.0.0/0`; Redeploy. |
| `bad auth` | Пароль в `DB_URL` (и логин) совпадают с Atlas; спецсимволы в пароле закодированы. |
| `Непредвиденная ошибка` (алерт) | Логи в Vercel (Functions → лог функции) или в Atlas/консоли — смотреть стек ошибки. |
| CORS / запрос блокируется | `CLIENT_URL` = точный URL фронта; запросы идут на тот же домен, что и API. |
| 404 на /api/* | Есть файл `api/[[...path]].js`, деплой прошёл, Root Directory в Vercel правильный. |

---

Если всё отмечено и ошибка остаётся — открой логи функции в Vercel (Dashboard → проект → Deployments → последний деплой → Function Logs) и пришли текст ошибки и момент действия (логин, регистрация, загрузка карточек).
